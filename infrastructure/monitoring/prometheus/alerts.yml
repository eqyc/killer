# =============================================================================
# KILLER ERP - Prometheus 告警规则
# =============================================================================
#
# 定义关键业务和基础设施告警。
#
# =============================================================================

# TODO: 实现完整告警规则

# groups:

# -----------------------------------------------------------------------------
# 服务可用性告警
# -----------------------------------------------------------------------------
#   - name: service_availability
#     rules:
#       # 服务宕机
#       - alert: ServiceDown
#         expr: up{job=~"killer-.*"} == 0
#         for: 1m
#         labels:
#           severity: critical
#         annotations:
#           summary: "服务 {{ $labels.job }} 不可用"
#           description: "服务 {{ $labels.instance }} 已宕机超过 1 分钟"

#       # 高错误率
#       - alert: HighErrorRate
#         expr: |
#           sum(rate(http_requests_total{status=~"5.."}[5m])) by (service)
#           /
#           sum(rate(http_requests_total[5m])) by (service)
#           > 0.05
#         for: 5m
#         labels:
#           severity: warning
#         annotations:
#           summary: "服务 {{ $labels.service }} 错误率过高"
#           description: "5xx 错误率超过 5%"

#       # 响应时间过长
#       - alert: HighLatency
#         expr: |
#           histogram_quantile(0.95,
#             sum(rate(http_request_duration_seconds_bucket[5m])) by (le, service)
#           ) > 1
#         for: 5m
#         labels:
#           severity: warning
#         annotations:
#           summary: "服务 {{ $labels.service }} 响应时间过长"
#           description: "P95 延迟超过 1 秒"

# -----------------------------------------------------------------------------
# 资源告警
# -----------------------------------------------------------------------------
#   - name: resource_alerts
#     rules:
#       # CPU 使用率过高
#       - alert: HighCPUUsage
#         expr: |
#           sum(rate(container_cpu_usage_seconds_total[5m])) by (pod)
#           /
#           sum(container_spec_cpu_quota/container_spec_cpu_period) by (pod)
#           > 0.8
#         for: 10m
#         labels:
#           severity: warning
#         annotations:
#           summary: "Pod {{ $labels.pod }} CPU 使用率过高"

#       # 内存使用率过高
#       - alert: HighMemoryUsage
#         expr: |
#           container_memory_usage_bytes / container_spec_memory_limit_bytes > 0.85
#         for: 10m
#         labels:
#           severity: warning
#         annotations:
#           summary: "Pod {{ $labels.pod }} 内存使用率过高"

#       # 磁盘空间不足
#       - alert: DiskSpaceLow
#         expr: |
#           (node_filesystem_avail_bytes / node_filesystem_size_bytes) < 0.1
#         for: 5m
#         labels:
#           severity: critical
#         annotations:
#           summary: "节点 {{ $labels.instance }} 磁盘空间不足"

# -----------------------------------------------------------------------------
# 数据库告警
# -----------------------------------------------------------------------------
#   - name: database_alerts
#     rules:
#       # PostgreSQL 连接数过高
#       - alert: PostgresConnectionsHigh
#         expr: |
#           pg_stat_activity_count / pg_settings_max_connections > 0.8
#         for: 5m
#         labels:
#           severity: warning
#         annotations:
#           summary: "PostgreSQL 连接数接近上限"

#       # 慢查询过多
#       - alert: PostgresSlowQueries
#         expr: |
#           rate(pg_stat_statements_seconds_total[5m]) > 1
#         for: 10m
#         labels:
#           severity: warning
#         annotations:
#           summary: "PostgreSQL 慢查询过多"

# -----------------------------------------------------------------------------
# 消息队列告警
# -----------------------------------------------------------------------------
#   - name: kafka_alerts
#     rules:
#       # 消费者延迟过高
#       - alert: KafkaConsumerLag
#         expr: |
#           kafka_consumergroup_lag > 10000
#         for: 10m
#         labels:
#           severity: warning
#         annotations:
#           summary: "Kafka 消费者组 {{ $labels.consumergroup }} 延迟过高"

#       # Broker 不可用
#       - alert: KafkaBrokerDown
#         expr: |
#           kafka_brokers < 3
#         for: 1m
#         labels:
#           severity: critical
#         annotations:
#           summary: "Kafka Broker 数量不足"

# -----------------------------------------------------------------------------
# 业务告警
# -----------------------------------------------------------------------------
#   - name: business_alerts
#     rules:
#       # 订单处理失败率
#       - alert: OrderProcessingFailures
#         expr: |
#           sum(rate(order_processing_failures_total[5m])) > 0.1
#         for: 5m
#         labels:
#           severity: critical
#           domain: commercial
#         annotations:
#           summary: "订单处理失败率过高"

#       # 支付超时
#       - alert: PaymentTimeout
#         expr: |
#           histogram_quantile(0.99,
#             sum(rate(payment_duration_seconds_bucket[5m])) by (le)
#           ) > 30
#         for: 5m
#         labels:
#           severity: critical
#           domain: finance
#         annotations:
#           summary: "支付处理超时"
