# ============================================================================
# KILLER ERP - 持续集成工作流
# ============================================================================
# 触发条件：
# - push 到 main/develop 分支
# - pull_request 到 main/develop 分支
# ============================================================================

name: CI

on:
  push:
    branches:
      - main
      - develop
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/dependabot.yml'
  pull_request:
    branches:
      - main
      - develop
    paths-ignore:
      - '**.md'
      - 'docs/**'

# 并发控制：同一分支/PR 只运行最新的工作流
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  # 最小支持的 Rust 版本
  MSRV: "1.75.0"

jobs:
  # ==========================================================================
  # 代码格式检查
  # ==========================================================================
  fmt:
    name: Format Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          components: rustfmt

      - name: Check formatting
        run: cargo fmt --all -- --check

  # ==========================================================================
  # 代码 Lint 检查
  # ==========================================================================
  clippy:
    name: Clippy Lint
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          components: clippy

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "clippy"

      - name: Run Clippy
        run: cargo clippy --workspace --all-targets --all-features -- -D warnings

  # ==========================================================================
  # 编译与测试（多平台矩阵）
  # ==========================================================================
  build-and-test:
    name: Build & Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30

    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - macos-latest
          - windows-latest
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - os: macos-latest
            target: x86_64-apple-darwin
          - os: windows-latest
            target: x86_64-pc-windows-msvc

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          target: ${{ matrix.target }}

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "build-${{ matrix.os }}"

      - name: Build
        run: cargo build --workspace --all-features

      - name: Run unit tests
        run: cargo test --workspace --lib --all-features

      - name: Run doc tests
        run: cargo test --workspace --doc --all-features

  # ==========================================================================
  # 集成测试（需要 Docker 服务）
  # ==========================================================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 45

    services:
      # PostgreSQL 服务
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: killer
          POSTGRES_PASSWORD: killer_test
          POSTGRES_DB: killer_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      # Redis 服务
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      DATABASE_URL: postgres://killer:killer_test@localhost:5432/killer_test
      REDIS_URL: redis://localhost:6379

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "integration"

      - name: Install sqlx-cli
        run: cargo install sqlx-cli --no-default-features --features rustls,postgres

      - name: Run database migrations
        run: cargo run -p killer-cli -- db migrate || echo "Migration CLI not available, skipping"

      - name: Run integration tests
        run: cargo test --workspace --test '*' -- --test-threads=1

  # ==========================================================================
  # 测试覆盖率
  # ==========================================================================
  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    timeout-minutes: 45

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: killer
          POSTGRES_PASSWORD: killer_test
          POSTGRES_DB: killer_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      DATABASE_URL: postgres://killer:killer_test@localhost:5432/killer_test

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          components: llvm-tools-preview

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "coverage"

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@cargo-llvm-cov

      - name: Generate coverage report
        run: cargo llvm-cov --workspace --lcov --output-path lcov.info

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: lcov.info
          fail_ci_if_error: false
          verbose: true

  # ==========================================================================
  # Proto 检查
  # ==========================================================================
  proto:
    name: Proto Lint
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Buf
        uses: bufbuild/buf-setup-action@v1
        with:
          version: 'latest'

      - name: Buf lint
        working-directory: proto
        run: buf lint || echo "Proto directory not configured, skipping"

      - name: Buf format check
        working-directory: proto
        run: buf format --diff --exit-code || echo "Proto directory not configured, skipping"

  # ==========================================================================
  # MSRV 检查（最小支持 Rust 版本）
  # ==========================================================================
  msrv:
    name: MSRV Check
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust toolchain (MSRV)
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: ${{ env.MSRV }}

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "msrv"

      - name: Check MSRV compatibility
        run: cargo check --workspace --all-features

  # ==========================================================================
  # 文档构建
  # ==========================================================================
  docs:
    name: Documentation
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "docs"

      - name: Build documentation
        run: cargo doc --workspace --no-deps --all-features
        env:
          RUSTDOCFLAGS: -D warnings

  # ==========================================================================
  # CI 成功标记（用于 branch protection）
  # ==========================================================================
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs:
      - fmt
      - clippy
      - build-and-test
      - integration-tests
      - proto
      - msrv
      - docs
    if: always()

    steps:
      - name: Check all jobs passed
        run: |
          if [[ "${{ needs.fmt.result }}" != "success" ]] || \
             [[ "${{ needs.clippy.result }}" != "success" ]] || \
             [[ "${{ needs.build-and-test.result }}" != "success" ]] || \
             [[ "${{ needs.integration-tests.result }}" != "success" ]] || \
             [[ "${{ needs.proto.result }}" != "success" ]] || \
             [[ "${{ needs.msrv.result }}" != "success" ]] || \
             [[ "${{ needs.docs.result }}" != "success" ]]; then
            echo "Some jobs failed"
            exit 1
          fi
          echo "All CI jobs passed successfully!"
