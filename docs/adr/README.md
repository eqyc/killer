# 架构决策记录 (ADR)

Architecture Decision Records - 记录 KILLER ERP 项目中重要的架构决策。

---

## 什么是 ADR？

架构决策记录（Architecture Decision Record，ADR）是一种轻量级文档，用于记录软件架构中的重要决策。每个 ADR 描述一个特定的架构决策，包括其背景、考虑的方案、最终选择及其理由。

ADR 的核心价值在于：
- **知识传承**：新成员可以快速理解为什么系统是这样设计的
- **决策追溯**：当需要重新评估决策时，可以回顾当时的背景和约束
- **避免重复讨论**：已记录的决策不需要反复讨论

---

## 为什么需要 ADR？

### 问题场景

1. **新人困惑**："为什么我们用 Rust 而不是 Go？"
2. **历史遗忘**："当初为什么选择这个方案？"
3. **重复争论**：同样的技术选型讨论反复出现
4. **决策漂移**：没有记录导致实现偏离原始设计意图

### ADR 的价值

| 价值 | 说明 |
|------|------|
| 透明度 | 所有人都能看到决策过程和理由 |
| 可追溯 | 决策有明确的时间线和负责人 |
| 学习资料 | 新成员的架构入门指南 |
| 变更依据 | 重新评估决策时的参考基准 |

---

## ADR 索引

| 编号 | 标题 | 状态 | 日期 |
|------|------|------|------|
| [ADR-0000](0000-use-architecture-decision-records.md) | 使用架构决策记录 | 已接受 | 2024-01-01 |
| [ADR-0001](0001-choose-rust-as-primary-language.md) | 选择 Rust 作为主开发语言 | 已接受 | 2024-01-05 |
| [ADR-0002](0002-adopt-grpc-for-service-communication.md) | 采用 gRPC 进行服务间通信 | 已接受 | 2024-01-10 |
| [ADR-0003](0003-implement-cqrs-pattern.md) | 实施 CQRS 模式 | 已接受 | 2024-01-15 |
| [ADR-0004](0004-use-postgresql-and-clickhouse.md) | 使用 PostgreSQL 和 ClickHouse 双数据库架构 | 已接受 | 2024-01-20 |
| [ADR-0005](0005-centralize-master-data-in-mdg-service.md) | 集中主数据管理于 MDG 服务 | 已接受 | 2024-01-25 |

---

## 如何创建新的 ADR？

### 步骤 1：复制模板

```bash
cp docs/adr/TEMPLATE.md docs/adr/XXXX-short-title.md
```

### 步骤 2：确定编号

- 查看现有 ADR 的最大编号
- 新 ADR 编号 = 最大编号 + 1
- 格式：4 位数字，前导零填充（0001, 0002, ...）

### 步骤 3：填写内容

1. 替换模板中的占位符
2. 详细描述问题背景
3. 列出所有考虑的方案（至少 2 个）
4. 客观分析每个方案的优缺点
5. 明确记录最终决策和理由

### 步骤 4：提交评审

1. 创建 Pull Request
2. 邀请相关团队成员评审
3. 在 PR 中讨论并完善
4. 合并后状态变为"已接受"

---

## ADR 编号规则

| 编号范围 | 用途 |
|----------|------|
| 0000-0099 | 基础架构决策（语言、框架、基础设施） |
| 0100-0199 | 数据架构决策（数据库、缓存、消息队列） |
| 0200-0299 | 安全架构决策（认证、授权、加密） |
| 0300-0399 | 集成架构决策（API、协议、外部系统） |
| 0400-0499 | 运维架构决策（部署、监控、日志） |
| 0500+ | 业务域特定决策 |

---

## ADR 状态管理

### 状态定义

| 状态 | 说明 | 下一步 |
|------|------|--------|
| **提议** | 正在讨论中，尚未达成共识 | → 已接受 / 已拒绝 |
| **已接受** | 团队已同意，正在或将要实施 | → 已弃用 / 已替代 |
| **已弃用** | 不再适用，但未被新决策替代 | 终态 |
| **已替代** | 被新的 ADR 替代 | 终态，链接到新 ADR |
| **已拒绝** | 讨论后决定不采纳 | 终态 |

### 状态流转

```
提议 ──┬──→ 已接受 ──┬──→ 已弃用
       │             │
       │             └──→ 已替代 (by ADR-XXXX)
       │
       └──→ 已拒绝
```

### 修改已接受的 ADR

1. **小幅修正**：直接修改原 ADR，在"修订历史"中记录
2. **重大变更**：创建新 ADR，将原 ADR 状态改为"已替代"

---

## ADR 最佳实践

### 应该记录的决策

- 技术栈选择（语言、框架、数据库）
- 架构模式选择（微服务、CQRS、事件溯源）
- 重要的设计模式应用
- 安全策略和合规要求
- 影响多个团队的接口设计

### 不需要记录的决策

- 代码风格和格式化规则（使用 linter 配置）
- 单个功能的实现细节
- 临时性的技术债务处理
- 已有行业标准的选择（如 JSON 格式）

### 写作建议

1. **保持简洁**：每个 ADR 控制在 1-2 页
2. **客观中立**：公正描述各方案优缺点
3. **面向未来读者**：假设读者不了解当时背景
4. **及时记录**：决策后尽快记录，避免遗忘细节

---

## 相关资源

- [MADR - Markdown ADR](https://adr.github.io/madr/)
- [ADR GitHub Organization](https://adr.github.io/)
- [Documenting Architecture Decisions - Michael Nygard](https://cognitect.com/blog/2011/11/15/documenting-architecture-decisions)

---

*最后更新: 2024-01*
