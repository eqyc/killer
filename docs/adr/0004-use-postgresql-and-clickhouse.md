# 0004. 使用 PostgreSQL 和 ClickHouse 双数据库架构

- **状态**: 已接受
- **决策者**: 架构组、数据团队
- **日期**: 2024-01-20
- **技术故事**: KILLER-58

## 背景与问题陈述

基于 ADR-0003 的 CQRS 决策，我们需要为命令端（写模型）和查询端（读模型）选择合适的数据库。系统的数据访问模式呈现明显的二元特征：

事务处理场景需要 ACID 保证、行级锁定、复杂的关联更新，典型操作包括创建凭证、提交订单、更新库存等。这类操作的特点是单次涉及少量数据，但要求强一致性。

分析查询场景需要扫描大量历史数据、执行聚合计算、生成报表，典型操作包括月度财务报表、销售趋势分析、库存周转率计算等。这类操作的特点是涉及海量数据，但可以接受最终一致性。

我们需要选择能够分别满足这两类场景需求的数据库技术。

## 决策驱动因素

- **OLTP 性能**: 事务处理需要低延迟、高并发
- **OLAP 性能**: 分析查询需要高吞吐、快速聚合
- **数据一致性**: 事务数据需要 ACID 保证
- **存储成本**: 历史数据量大，需要高效压缩
- **运维成熟度**: 需要稳定可靠的生产级方案
- **生态兼容**: 需要与 Rust 生态良好集成

## 考虑的方案

### 方案 1: 单一 PostgreSQL

使用 PostgreSQL 同时处理 OLTP 和 OLAP 负载，通过物化视图和分区表优化查询性能。

**优点**:
- 架构简单，单一数据源
- 运维成本低
- 强一致性，无同步问题
- PostgreSQL 生态成熟

**缺点**:
- 大规模聚合查询性能受限
- OLAP 查询可能影响 OLTP 性能
- 列式存储支持有限
- 历史数据压缩率不高

### 方案 2: PostgreSQL + ClickHouse

PostgreSQL 作为 OLTP 数据库处理事务，ClickHouse 作为 OLAP 数据库处理分析查询。通过 Kafka 实现数据同步。

**优点**:
- OLTP 和 OLAP 各用最优方案
- ClickHouse 聚合查询性能卓越（比 PG 快 10-100 倍）
- 列式存储，压缩率高（10:1）
- 读写负载完全隔离

**缺点**:
- 架构复杂度增加
- 需要维护数据同步管道
- 最终一致性，有同步延迟
- 运维两套数据库系统

### 方案 3: PostgreSQL + TimescaleDB

使用 TimescaleDB 扩展 PostgreSQL 的时序数据处理能力。

**优点**:
- 基于 PostgreSQL，学习成本低
- 时序数据优化
- 自动分区管理
- 保持 SQL 兼容性

**缺点**:
- 聚合性能不如专用 OLAP 数据库
- 主要针对时序场景，通用分析能力有限
- 大规模数据下性能下降明显

## 决策结果

**选择方案**: 方案 2 - PostgreSQL + ClickHouse

**理由**:

PostgreSQL 是 OLTP 场景的最佳选择之一。它提供完整的 ACID 支持、丰富的数据类型、强大的扩展能力，以及成熟的 Rust 驱动（sqlx、diesel）。对于我们的事务处理需求，PostgreSQL 完全能够胜任。

ClickHouse 在 OLAP 场景的性能优势是决定性的。在我们的基准测试中，相同的聚合查询 ClickHouse 比 PostgreSQL 快 50-100 倍。对于需要扫描数亿行数据的财务报表，这种性能差异意味着从分钟级降到秒级。ClickHouse 的列式存储和向量化执行引擎专为分析场景设计。

数据同步通过 Kafka 实现。业务服务发布领域事件到 Kafka，专门的同步服务消费事件并写入 ClickHouse。这种架构解耦了写入和同步过程，即使 ClickHouse 暂时不可用也不影响业务写入。

## 积极后果

- 事务处理和分析查询性能都达到最优
- 报表生成时间从分钟级降到秒级
- 历史数据存储成本降低（高压缩率）
- 为实时数据分析和 BI 奠定基础

## 消极后果

- 需要运维两套数据库系统
- 数据同步增加了系统复杂度
- 查询端数据有秒级延迟
- 团队需要学习 ClickHouse

## 遵从性

- 所有事务操作必须使用 PostgreSQL
- 复杂报表和分析查询必须使用 ClickHouse
- 数据同步延迟监控，告警阈值 5 秒
- 定期验证两端数据一致性

## 相关链接

- [ADR-0003: 实施 CQRS 模式](0003-implement-cqrs-pattern.md)
- [PostgreSQL 官方文档](https://www.postgresql.org/docs/)
- [ClickHouse 官方文档](https://clickhouse.com/docs/)
- [sqlx - Rust PostgreSQL 驱动](https://github.com/launchbadge/sqlx)

---

## 修订历史

| 日期 | 版本 | 变更内容 | 作者 |
|------|------|----------|------|
| 2024-01-20 | 1.0 | 初始版本 | 架构组 |
