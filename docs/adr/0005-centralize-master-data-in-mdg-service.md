# 0005. 集中主数据管理于 MDG 服务

- **状态**: 已接受
- **决策者**: 架构组、业务架构师
- **日期**: 2024-01-25
- **技术故事**: KILLER-75

## 背景与问题陈述

KILLER ERP 系统包含多个业务域服务：财务、销售、采购、生产、物流等。这些服务都需要访问共同的主数据，包括：客户主数据、供应商主数据、物料主数据、组织架构、科目表等。

在微服务架构下，主数据的管理面临挑战。如果每个服务维护自己的主数据副本，会导致数据不一致、更新困难、存储冗余等问题。如果所有服务都直接访问同一个数据库，又会造成紧耦合和单点瓶颈。

我们需要设计一种主数据管理策略，既能保证数据一致性，又能支持服务的独立性和可扩展性。

## 决策驱动因素

- **数据一致性**: 主数据在所有服务中必须一致
- **单一数据源**: 每类主数据应有唯一的权威来源
- **服务自治**: 业务服务不应强依赖其他服务的可用性
- **变更传播**: 主数据变更需要及时通知相关服务
- **查询性能**: 主数据查询是高频操作，需要低延迟

## 考虑的方案

### 方案 1: 共享数据库

所有服务直接访问同一个主数据库，通过数据库层面保证一致性。

**优点**:
- 实现简单，无需同步机制
- 数据实时一致
- 无冗余存储

**缺点**:
- 服务间紧耦合
- 数据库成为单点瓶颈
- 违反微服务数据隔离原则
- 难以独立扩展

### 方案 2: 集中式 MDG 服务 + 事件驱动同步

创建专门的主数据治理（MDG）服务作为主数据的唯一权威来源。其他服务通过 gRPC 查询主数据，通过 Kafka 订阅主数据变更事件，在本地维护只读副本。

**优点**:
- 单一数据源，数据一致性有保障
- 服务可以使用本地缓存，降低查询延迟
- 主数据变更通过事件异步传播
- MDG 服务可以实现复杂的数据治理逻辑

**缺点**:
- 需要维护数据同步机制
- 本地副本存在短暂不一致窗口
- MDG 服务需要高可用保障
- 增加了系统复杂度

### 方案 3: 去中心化 + Saga 协调

每个服务管理自己领域内的主数据，跨域数据通过 Saga 模式协调一致性。

**优点**:
- 完全去中心化，无单点
- 服务完全自治
- 符合 DDD 限界上下文理念

**缺点**:
- 主数据定义可能不一致
- Saga 协调复杂度高
- 难以实现全局数据治理
- 跨域查询困难

## 决策结果

**选择方案**: 方案 2 - 集中式 MDG 服务 + 事件驱动同步

**理由**:

主数据的本质特征决定了它需要集中管理。客户、供应商、物料等主数据在整个企业范围内应该有统一的定义和唯一的权威来源。MDG 服务承担这个职责，确保主数据的质量和一致性。

事件驱动的同步机制平衡了一致性和可用性。业务服务在本地维护主数据的只读副本，日常查询直接访问本地缓存，无需跨服务调用。当主数据变更时，MDG 服务发布事件，各服务异步更新本地副本。这种最终一致性对于主数据场景是可接受的——主数据变更频率低，且通常有审批流程。

对于实时性要求高的场景（如创建订单时验证客户状态），服务可以直接调用 MDG 服务的 gRPC 接口获取最新数据。我们通过合理的缓存策略和 TTL 设置来平衡性能和一致性。

## 积极后果

- 主数据有统一的权威来源
- 业务服务可以独立运行（使用本地缓存）
- 主数据变更可追溯、可审计
- 支持复杂的数据治理规则（如数据质量检查）

## 消极后果

- MDG 服务成为关键依赖，需要高可用保障
- 本地副本存在短暂不一致窗口
- 需要维护事件同步机制
- 存储有一定冗余

## 遵从性

- 所有主数据的创建和修改必须通过 MDG 服务
- 业务服务禁止直接修改主数据
- 主数据查询优先使用本地缓存
- 缓存 TTL 设置：客户/供应商 5 分钟，物料 10 分钟

## 相关链接

- [ADR-0002: 采用 gRPC 进行服务间通信](0002-adopt-grpc-for-service-communication.md)
- [ERP主数据治理 概念](https://www.example.com/mdg.html)
- [微服务中的数据管理](https://microservices.io/patterns/data/database-per-service.html)

---

## 修订历史

| 日期 | 版本 | 变更内容 | 作者 |
|------|------|----------|------|
| 2024-01-25 | 1.0 | 初始版本 | 架构组 |
