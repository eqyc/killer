# 0002. 采用 gRPC 进行服务间通信

- **状态**: 已接受
- **决策者**: 架构组
- **日期**: 2024-01-10
- **技术故事**: KILLER-25

## 背景与问题陈述

KILLER ERP 采用微服务架构，系统由数十个独立服务组成，包括财务服务、销售服务、采购服务等。这些服务需要频繁地进行同步通信，如查询主数据、验证业务规则、获取实时状态等。

我们需要选择一种高效、可靠的服务间通信协议。该协议需要满足以下需求：低延迟的同步调用、强类型的接口契约、良好的跨语言支持（考虑未来可能的多语言场景）、支持流式传输（大数据量场景）。

目前主流的选择包括 REST/HTTP、gRPC 和 GraphQL。我们需要评估这些方案并做出选择。

## 决策驱动因素

- **性能**: 服务间调用延迟要求极低
- **类型安全**: 接口变更需要编译期检测
- **开发效率**: 减少样板代码，自动生成客户端
- **可演进性**: 接口支持向后兼容演进
- **流式支持**: 部分场景需要流式数据传输
- **调试友好**: 便于开发和问题排查

## 考虑的方案

### 方案 1: REST/HTTP + JSON

使用传统的 RESTful API，以 JSON 作为数据交换格式。

**优点**:
- 简单直观，开发者熟悉
- 浏览器原生支持，调试方便
- 丰富的工具生态（Postman、curl）
- 无需额外的代码生成步骤

**缺点**:
- JSON 序列化/反序列化开销较大
- 缺乏强类型约束，运行时才发现问题
- HTTP/1.1 存在队头阻塞问题
- 不支持原生流式传输

### 方案 2: gRPC + Protocol Buffers

使用 Google 的 gRPC 框架，以 Protocol Buffers 作为接口定义语言和序列化格式。

**优点**:
- 高性能：二进制序列化，比 JSON 快 5-10 倍
- 强类型：.proto 文件定义接口，编译期类型检查
- HTTP/2：多路复用、头部压缩、流式支持
- 代码生成：自动生成客户端和服务端代码
- 跨语言：支持主流编程语言

**缺点**:
- 学习曲线：需要学习 Protocol Buffers 语法
- 调试较难：二进制格式不可直读
- 浏览器支持需要 gRPC-Web
- 需要额外的代码生成步骤

### 方案 3: GraphQL

使用 GraphQL 作为 API 查询语言，客户端可以精确指定所需数据。

**优点**:
- 灵活查询：客户端按需获取数据
- 强类型 Schema
- 减少请求次数（避免过度获取/获取不足）
- 良好的开发工具（GraphiQL）

**缺点**:
- 复杂查询的性能优化困难
- 缓存策略复杂
- 不适合非查询类操作
- Rust 生态支持相对较弱

## 决策结果

**选择方案**: 方案 2 - gRPC + Protocol Buffers

**理由**:

gRPC 的高性能特性与我们的低延迟需求高度契合。Protocol Buffers 的二进制序列化比 JSON 高效 5-10 倍，在服务间大量通信的场景下，这种效率提升非常显著。HTTP/2 的多路复用特性也避免了传统 HTTP/1.1 的队头阻塞问题。

强类型的 .proto 接口定义是另一个关键优势。接口变更会在编译期被检测到，而不是在运行时才暴露问题。这对于由多个团队协作开发的大型系统尤为重要。

gRPC 原生支持四种流式模式（Unary、Server Streaming、Client Streaming、Bidirectional），这为大数据量导出、实时推送等场景提供了优雅的解决方案。

对于调试困难的问题，我们计划通过 gRPC Reflection 和专用的调试工具（如 grpcurl、BloomRPC）来缓解。对外部系统的 API 暴露，我们仍会提供 REST 网关。

## 积极后果

- 服务间通信性能显著提升
- 接口契约清晰，编译期类型安全
- 自动生成代码减少样板代码
- 流式 RPC 支持大数据量场景
- 良好的向后兼容性支持

## 消极后果

- 团队需要学习 Protocol Buffers 和 gRPC
- 需要维护 .proto 文件和代码生成流程
- 调试不如 REST/JSON 直观
- 需要额外提供 REST 网关供外部系统调用

## 遵从性

- 所有服务间同步通信必须使用 gRPC
- .proto 文件集中管理在 proto/ 目录
- CI 流程包含 proto 编译和兼容性检查
- 对外 API 通过 API Gateway 转换为 REST

## 相关链接

- [ADR-0001: 选择 Rust 作为主开发语言](0001-choose-rust-as-primary-language.md)
- [gRPC 官方文档](https://grpc.io/)
- [Tonic - Rust gRPC 实现](https://github.com/hyperium/tonic)
- [Protocol Buffers 语言指南](https://developers.google.com/protocol-buffers)

---

## 修订历史

| 日期 | 版本 | 变更内容 | 作者 |
|------|------|----------|------|
| 2024-01-10 | 1.0 | 初始版本 | 架构组 |
